# Slack Integration Guide

FlakeGuard integrates with Slack to provide real-time notifications about flaky test detections, quarantine recommendations, and test quality insights directly in your team channels.

## Overview

The Slack integration provides:

- **Real-time Alerts**: Immediate notifications when flaky tests are detected
- **Quarantine Notifications**: Alerts when tests are recommended for quarantine
- **Daily Summaries**: Regular reports on test quality metrics
- **Interactive Actions**: Quick actions to manage flaky tests from Slack
- **Team Mentions**: Notify specific teams or individuals about critical issues

## Setup Instructions

### 1. Create Slack App

1. **Navigate to Slack API**
   - Go to [https://api.slack.com/apps](https://api.slack.com/apps)
   - Click **"Create New App"**
   - Choose **"From scratch"**

2. **Basic Information**
   ```yaml
   App Name: FlakeGuard Bot
   Development Slack Workspace: your-workspace
   ```

### 2. Configure OAuth & Permissions

#### Bot Token Scopes

Add the following OAuth scopes:

```yaml
OAuth & Permissions ‚Üí Scopes ‚Üí Bot Token Scopes:
- chat:write           # Send messages to channels
- chat:write.public    # Send messages to public channels without joining
- channels:read        # List public channels
- groups:read          # List private channels
- im:write            # Send direct messages
- users:read          # Read user information
- files:write         # Upload files and screenshots
- reactions:write     # Add reactions to messages
```

#### User Token Scopes (Optional)

For enhanced functionality:

```yaml
User Token Scopes:
- channels:history     # Read channel message history
- chat:write          # Send messages as user
```

### 3. Install App to Workspace

1. **Install App**
   - Go to **"Install App"** section
   - Click **"Install to Workspace"**
   - Authorize the requested permissions

2. **Get Tokens**
   ```bash
   # Bot User OAuth Token (starts with xoxb-)
   SLACK_BOT_TOKEN=xoxb-your-bot-token-here
   
   # User OAuth Token (starts with xoxp-) - Optional
   SLACK_USER_TOKEN=xoxp-your-user-token-here
   ```

### 4. Configure Incoming Webhooks (Optional)

For simpler notifications without interactive features:

1. **Enable Incoming Webhooks**
   - Go to **"Incoming Webhooks"** section
   - Activate incoming webhooks
   - Click **"Add New Webhook to Workspace"**
   - Select channel for notifications

2. **Get Webhook URL**
   ```bash
   SLACK_WEBHOOK_URL=https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX
   ```

### 5. Environment Configuration

Add Slack configuration to your FlakeGuard environment:

```bash
# .env file
SLACK_BOT_TOKEN=xoxb-your-bot-token-here
SLACK_SIGNING_SECRET=your-slack-signing-secret
SLACK_DEFAULT_CHANNEL=#dev-alerts
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...

# Optional: Team-specific channels
SLACK_FRONTEND_CHANNEL=#frontend-team
SLACK_BACKEND_CHANNEL=#backend-team
SLACK_QA_CHANNEL=#qa-team
```

## Notification Types

### 1. Flaky Test Alerts

Immediate notification when a flaky test is detected:

```typescript
// Example notification payload
{
  "type": "flake_detected",
  "data": {
    "repository": "owner/repository",
    "testName": "TestUserAuthentication.testLoginFlow",
    "flakeScore": 0.75,
    "confidence": 0.85,
    "failureRate": 0.27,
    "totalRuns": 45,
    "recentFailures": 5,
    "lastFailureAt": "2024-01-15T10:30:00Z",
    "suggestedAction": "quarantine",
    "priority": "high"
  }
}
```

**Slack Message:**
```markdown
üö® **High Priority Flaky Test Detected**

**Repository:** owner/repository
**Test:** `TestUserAuthentication.testLoginFlow`
**Flakiness Score:** 75% (High Confidence)
**Failure Rate:** 27% (12/45 runs)

**Recent Pattern:**
‚Ä¢ 5 failures in last 7 days
‚Ä¢ Last failure: 2 hours ago
‚Ä¢ Recommended action: Quarantine

[View Details](https://flakeguard.dev/repos/owner/repository/flakes/123) | [Quarantine Now] | [Dismiss]
```

### 2. Quarantine Recommendations

Daily or weekly summaries of tests recommended for quarantine:

```markdown
üìã **Weekly Quarantine Report - owner/repository**

Found **3 tests** recommended for quarantine:

**High Priority (2):**
‚Ä¢ `TestPaymentFlow.testCreditCardValidation` - 82% flakiness
‚Ä¢ `TestUserAuth.testSocialLogin` - 78% flakiness

**Medium Priority (1):**
‚Ä¢ `TestEmailService.testBulkSend` - 65% flakiness

**Actions:**
[Quarantine All High Priority] | [View Full Report] | [Configure Alerts]

*Generated by FlakeGuard at 2024-01-15 09:00 UTC*
```

### 3. Test Quality Summary

Regular reports on overall test quality:

```markdown
üìä **Daily Test Quality Report**

**Repository:** owner/repository
**Period:** Last 24 hours

**Overview:**
‚úÖ Pass Rate: 89% (‚Üë2% from yesterday)
‚ö†Ô∏è Flaky Tests: 12 (‚Üì1 from yesterday)  
üîí Quarantined: 3 tests
‚è±Ô∏è Avg Test Time: 2.3s (‚Üì0.1s)

**Top Issues:**
1. Integration suite: 15% flake rate
2. E2E tests: High variability in timing
3. Database tests: Connection timeout spikes

[View Analytics Dashboard](https://flakeguard.dev/analytics)
```

### 4. Critical Alerts

Immediate alerts for critical situations:

```markdown
üî• **CRITICAL: Test Suite Failure Spike**

**Repository:** owner/repository
**Issue:** Failure rate increased to 45% in last hour

**Affected Tests:**
‚Ä¢ Database connection tests (8 failures)
‚Ä¢ API integration tests (12 failures)
‚Ä¢ User authentication flow (5 failures)

**Possible Causes:**
‚Ä¢ Infrastructure issues
‚Ä¢ Recent deployment impact
‚Ä¢ External service degradation

[View Incident Dashboard] | [Notify On-Call] | [Run Diagnostics]
```

## Configuration Options

### Channel Routing

Configure different notification types to different channels:

```typescript
// config/slack.ts
export interface SlackConfig {
  botToken: string;
  signingSecret: string;
  channels: {
    alerts: string;          // #dev-alerts
    quarantine: string;      // #test-quality
    summaries: string;       // #daily-reports
    critical: string;        // #incidents
    team: {
      frontend: string;      // #frontend-team  
      backend: string;       // #backend-team
      qa: string;           // #qa-team
    };
  };
  notifications: {
    flakeThreshold: number;     // 0.6 - Only notify for scores >= 60%
    enableDailySummary: boolean;
    enableWeeklyReport: boolean;
    criticalFailureRate: number; // 0.3 - Alert when >30% failures
  };
}
```

### Notification Filters

Control which notifications are sent:

```typescript
// Notification filtering rules
export interface NotificationRules {
  flakeDetection: {
    minScore: number;           // 0.5 - Minimum flakiness score
    minConfidence: number;      // 0.7 - Minimum confidence level
    repositories: string[];     // Specific repos to monitor
    excludePatterns: string[];  // Test patterns to exclude
    priority: 'low' | 'medium' | 'high' | 'critical';
  };
  
  quarantineRecommendations: {
    frequency: 'daily' | 'weekly';
    minCandidates: number;      // 1 - Minimum tests to report
    includeRationale: boolean;  // Include detailed reasoning
  };
  
  qualitySummary: {
    enabled: boolean;
    schedule: string;           // Cron expression
    includeCharts: boolean;     // Include trend charts
    comparePreviousPeriod: boolean;
  };
}
```

## Interactive Features

### Slash Commands

Register slash commands for direct interaction:

#### `/flakeguard status`

Check FlakeGuard status and recent activity:

```markdown
**FlakeGuard Status** ‚úÖ

**System Health:** All systems operational
**Last Analysis:** 5 minutes ago
**Monitored Repos:** 23 repositories
**Active Flakes:** 15 tests under monitoring

**Recent Activity:**
‚Ä¢ 2 new flaky tests detected (last hour)
‚Ä¢ 1 test quarantined (frontend-app)
‚Ä¢ 3 tests marked stable (backend-api)

[View Dashboard](https://flakeguard.dev/dashboard)
```

#### `/flakeguard repo <repo-name>`

Get repository-specific information:

```markdown
**Repository: owner/frontend-app** üìä

**Test Quality Score:** B+ (82/100)
**Flaky Tests:** 8 detected, 3 quarantined
**Pass Rate:** 91% (last 7 days)
**Test Count:** 245 tests

**Recent Flaky Tests:**
‚Ä¢ `LoginForm.testValidation` - 75% flakiness
‚Ä¢ `PaymentFlow.testSubmission` - 68% flakiness

[View Repository Details](https://flakeguard.dev/repos/owner/frontend-app)
```

#### `/flakeguard quarantine <test-name>`

Quarantine a specific test:

```markdown
‚úÖ **Test Quarantined Successfully**

**Test:** `TestUserAuth.testSocialLogin`
**Repository:** owner/backend-api
**Reason:** Manual quarantine via Slack
**Quarantined by:** @john.doe

The test has been marked as quarantined and will be excluded from future runs until resolved.

[View Quarantined Tests] | [Add Comment] | [Undo Quarantine]
```

### Interactive Buttons

Add interactive buttons to notifications:

```typescript
// Slack Block Kit buttons
const blocks = [
  {
    type: "section",
    text: {
      type: "mrkdwn",
      text: "üö® Flaky test detected: `TestPaymentFlow`"
    }
  },
  {
    type: "actions",
    elements: [
      {
        type: "button",
        text: { type: "plain_text", text: "Quarantine" },
        style: "danger",
        action_id: "quarantine_test",
        value: "test_123456"
      },
      {
        type: "button", 
        text: { type: "plain_text", text: "View Details" },
        action_id: "view_test_details",
        url: "https://flakeguard.dev/tests/123456"
      },
      {
        type: "button",
        text: { type: "plain_text", text: "Dismiss" },
        action_id: "dismiss_alert",
        value: "alert_789"
      }
    ]
  }
];
```

## Implementation Example

### Basic Slack Notifier

```typescript
// slack/notifier.ts
import { WebClient } from '@slack/web-api';

export class SlackNotifier {
  private client: WebClient;
  
  constructor(botToken: string) {
    this.client = new WebClient(botToken);
  }
  
  async sendFlakeAlert(flakeData: FlakeDetection): Promise<void> {
    const blocks = this.buildFlakeAlertBlocks(flakeData);
    
    await this.client.chat.postMessage({
      channel: process.env.SLACK_ALERTS_CHANNEL,
      blocks,
      text: `Flaky test detected: ${flakeData.testName}`,
    });
  }
  
  async sendQuarantineReport(
    repository: string, 
    candidates: QuarantineCandidate[]
  ): Promise<void> {
    const blocks = this.buildQuarantineReportBlocks(repository, candidates);
    
    await this.client.chat.postMessage({
      channel: process.env.SLACK_QUARANTINE_CHANNEL,
      blocks,
      text: `Quarantine report for ${repository}`,
    });
  }
  
  private buildFlakeAlertBlocks(flake: FlakeDetection) {
    return [
      {
        type: "header",
        text: {
          type: "plain_text",
          text: "üö® Flaky Test Alert"
        }
      },
      {
        type: "section",
        fields: [
          { type: "mrkdwn", text: `*Repository:*\n${flake.repository}` },
          { type: "mrkdwn", text: `*Test:*\n\`${flake.testName}\`` },
          { type: "mrkdwn", text: `*Flakiness:*\n${(flake.score * 100).toFixed(0)}%` },
          { type: "mrkdwn", text: `*Confidence:*\n${(flake.confidence * 100).toFixed(0)}%` }
        ]
      },
      {
        type: "section",
        text: {
          type: "mrkdwn",
          text: `*Failure Rate:* ${(flake.failureRate * 100).toFixed(1)}% (${flake.failures}/${flake.totalRuns} runs)\n*Recent Failures:* ${flake.recentFailures} in last 7 days\n*Priority:* ${flake.priority.toUpperCase()}`
        }
      },
      {
        type: "actions",
        elements: [
          {
            type: "button",
            text: { type: "plain_text", text: "üîí Quarantine" },
            style: "danger",
            action_id: "quarantine_test",
            value: flake.id
          },
          {
            type: "button",
            text: { type: "plain_text", text: "üìä View Details" },
            action_id: "view_details",
            url: `${process.env.FLAKEGUARD_URL}/flakes/${flake.id}`
          },
          {
            type: "button",
            text: { type: "plain_text", text: "‚ùå Dismiss" },
            action_id: "dismiss_flake",
            value: flake.id
          }
        ]
      }
    ];
  }
}
```

### Advanced Features

#### Thread Conversations

Keep related updates in threads:

```typescript
// Update existing flake alert in thread
await this.client.chat.postMessage({
  channel: channelId,
  thread_ts: originalMessageTs,
  text: "‚úÖ Test has been quarantined successfully"
});
```

#### Rich Formatting

Use Slack's rich formatting features:

```typescript
// Format code blocks with syntax highlighting
const codeBlock = {
  type: "section",
  text: {
    type: "mrkdwn",
    text: "```java\n@Test\npublic void testUserLogin() {\n  // Flaky test implementation\n}\n```"
  }
};

// Add context with timestamps
const context = {
  type: "context",
  elements: [
    {
      type: "mrkdwn",
      text: `Last updated: <!date^${Math.floor(Date.now()/1000)}^{date_short_pretty} at {time}|${new Date().toISOString()}>`
    }
  ]
};
```

#### File Uploads

Share detailed reports as files:

```typescript
// Upload quarantine report as CSV
await this.client.files.upload({
  channels: channelId,
  file: fs.createReadStream('quarantine-report.csv'),
  filename: 'quarantine-report.csv',
  title: 'Weekly Quarantine Report',
  initial_comment: 'Here is the detailed quarantine report for this week.'
});
```

## Monitoring and Analytics

### Slack Metrics

Track Slack integration effectiveness:

```typescript
interface SlackMetrics {
  messagesDelivered: number;
  interactionsReceived: number;
  quarantineActions: number;
  dismissalRate: number;
  channelEngagement: Record<string, number>;
}
```

### A/B Testing

Test different notification formats:

```typescript
// Experiment with different message formats
const messageVariants = {
  concise: buildConciseAlert(flake),
  detailed: buildDetailedAlert(flake),
  visual: buildVisualAlert(flake)
};

const variant = selectVariant(userId);
await sendMessage(messageVariants[variant]);
```

## Troubleshooting

### Common Issues

#### 1. Missing Permissions

```bash
# Error: missing_scope
# Solution: Add required OAuth scopes in Slack App settings
```

#### 2. Channel Not Found

```typescript
// Validate channel exists before sending
try {
  await slack.conversations.info({ channel: channelId });
} catch (error) {
  if (error.data?.error === 'channel_not_found') {
    // Handle missing channel
    console.error(`Channel ${channelId} not found`);
  }
}
```

#### 3. Rate Limiting

```typescript
// Handle rate limits with retry logic
import { retryPolicies } from '@slack/web-api';

const client = new WebClient(token, {
  retryConfig: retryPolicies.rapidRetryPolicy
});
```

### Debug Mode

Enable debug logging:

```bash
# Environment variables
SLACK_LOG_LEVEL=debug
DEBUG=slack:*
```

This comprehensive Slack integration enables your team to stay informed about test quality issues and take quick action to maintain a healthy test suite.